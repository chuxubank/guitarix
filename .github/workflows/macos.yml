name: macos-build

on:
  push:
    branches: ["**"]
  pull_request:

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          brew update
          brew install \
            gperf \
            intltool \
            boost \
            eigen \
            gtk+3 \
            gtkmm3 \
            jack \
            lilv \
            lrdf \
            libsndfile \
            fftw \
            lv2 \
            sassc

      - name: Set environment variables
        run: |
          FFTW_PREFIX="$(brew --prefix fftw)"
          BOOST_PREFIX="$(brew --prefix boost)"
          echo "CPATH=${FFTW_PREFIX}/include:${BOOST_PREFIX}/include${CPATH:+:$CPATH}" >> "$GITHUB_ENV"
          echo "LIBRARY_PATH=${FFTW_PREFIX}/lib:${BOOST_PREFIX}/lib${LIBRARY_PATH:+:$LIBRARY_PATH}" >> "$GITHUB_ENV"
          echo "PKG_CONFIG_PATH=${FFTW_PREFIX}/lib/pkgconfig${PKG_CONFIG_PATH:+:$PKG_CONFIG_PATH}" >> "$GITHUB_ENV"

      - name: Configure
        working-directory: trunk
        run: ./waf configure --prefix=/usr/local --includeresampler --includeconvolver --optimization

      - name: Build
        working-directory: trunk
        run: ./waf build
